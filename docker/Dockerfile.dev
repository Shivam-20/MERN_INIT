# Development stage - Optimized for speed
FROM node:18-alpine

# Set working directory
WORKDIR /app

# Install system dependencies in one layer
RUN apk add --no-cache curl git python3 make g++

# Copy package files first for better caching
COPY package*.json ./
COPY server/package*.json ./server/

# Install dependencies with optimizations
RUN npm install -g nodemon --silent && \
    npm ci --only=production --silent --no-audit --no-fund && \
    npm cache clean --force

# Install server dependencies
WORKDIR /app/server
RUN npm ci --silent --no-audit --no-fund && \
    npm cache clean --force

# Set working directory back to root
WORKDIR /app

# Copy application code
COPY . .

# Expose the application port
EXPOSE 5000

# Command to run the application
CMD ["npm", "run", "dev"]
